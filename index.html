<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        /* Custom soft shadow */
        .soft-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
        .card-bg { background-color: #ffffff; }
        .main-content { padding-bottom: 72px; /* Space for the fixed bottom nav */ }
        .nav-btn {
            @apply flex flex-col items-center justify-center p-1 text-sm transition-colors duration-200;
        }
        .file-input-label {
            @apply flex items-center justify-center bg-gray-100 text-gray-700 py-2 rounded-lg cursor-pointer hover:bg-gray-200 transition duration-150 border border-gray-300;
        }
        .file-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
        /* Custom scrollbar for mobile feel */
        .scroll-list::-webkit-scrollbar {
            display: none;
        }
        .scroll-list {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body>

    <div id="app" class="max-w-md mx-auto min-h-screen relative soft-shadow">

        <!-- Header -->
        <header class="bg-white p-4 soft-shadow sticky top-0 z-10">
            <h1 id="header-title" class="text-xl font-bold text-gray-800">Dashboard</h1>
        </header>

        <!-- --- DEBUG MESSAGE - THIS WILL DISAPPEAR IF JS RUNS --- -->
        <!-- Note: If you see this, the JS code is not running! -->
        <div id="debug-error" class="p-4 bg-red-100 border-l-4 border-red-500 text-red-700 m-4 rounded-lg soft-shadow">
            <p class="font-bold">Initialization Error</p>
            <p class="text-sm">The application's logic is not starting. This usually means the file name is wrong (must be index.html) or the script tags were corrupted during copy/paste. Please refresh the page or check the file content on GitHub.</p>
        </div>
        <!-- -------------------------------------------------------- -->

        <!-- Main Content Area -->
        <div id="view-content" class="p-4 main-content">
            <!-- Content will be injected here by JavaScript -->
        </div>

        <!-- Fixed Bottom Navigation Bar -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-200 z-20 soft-shadow">
            <div class="flex justify-around h-16">
                <button class="nav-btn text-blue-600 active-nav" data-view="dashboard">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2m-7 7h3m-7 7h3a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h3"></path></svg>
                    <span class="text-xs">Home</span>
                </button>
                <button class="nav-btn text-gray-500 hover:text-blue-600" data-view="productList">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h.01"></path></svg>
                    <span class="text-xs">Products</span>
                </button>
                <button class="nav-btn text-gray-500 hover:text-blue-600" data-view="orders">
                    <!-- Changed data-view from addOrder to orders for list view -->
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5h6"></path></svg>
                    <span class="text-xs">Orders</span>
                </button>
                <button class="nav-btn text-gray-500 hover:text-blue-600" data-view="customerList">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    <span class="text-xs">Customers</span>
                </button>
                <button class="nav-btn text-gray-500 hover:text-blue-600" data-view="reports">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-2.414-2.414A1 1 0 0015.586 6H7a2 2 0 00-2 2v11a2 2 0 002 2z"></path></svg>
                    <span class="text-xs">Reports</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Modal for Messages/Confirmation (in place of alert/confirm) -->
    <div id="message-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl soft-shadow max-w-xs mx-auto">
            <h3 id="modal-title" class="text-lg font-bold mb-3 text-gray-800">Notification</h3>
            <p id="modal-message" class="text-sm text-gray-600 mb-4"></p>
            <button onclick="closeModal()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-150">Got It</button>
        </div>
    </div>

<script>
    // --- Global State and Utility Functions ---

    // Hides the debug message as soon as the JavaScript begins execution
    document.getElementById('debug-error').style.display = 'none';

    // Global constant for Indian Rupee symbol
    const CURRENCY_SYMBOL = '₹';

    const STATUS_OPTIONS = [
        'Pending',
        'Processing',
        'Delivered',
        'Cancelled'
    ];

    const STORAGE_KEYS = {
        PRODUCTS: 'order_manager_products',
        CUSTOMERS: 'order_manager_customers',
        ORDERS: 'order_manager_orders',
    };

    const DOM = {
        content: document.getElementById('view-content'),
        title: document.getElementById('header-title'),
        navButtons: document.querySelectorAll('.nav-btn'),
        modal: document.getElementById('message-modal'),
        modalTitle: document.getElementById('modal-title'),
        modalMessage: document.getElementById('modal-message'),
    };

    let data = {
        products: [],
        customers: [],
        orders: [],
    };

    function loadData() {
        try {
            data.products = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS) || '[]')
                .map(p => ({...p, id: p.id || generateId()})); 
            data.customers = JSON.parse(localStorage.getItem(STORAGE_KEYS.CUSTOMERS) || '[]')
                .map(c => ({...c, id: c.id || generateId()})); 
            data.orders = JSON.parse(localStorage.getItem(STORAGE_KEYS.ORDERS) || '[]');
            console.log("Data loaded successfully.");
        } catch (e) {
            console.error("Error loading data from localStorage:", e);
        }
    }

    function saveData(key, items) {
        try {
            localStorage.setItem(key, JSON.stringify(items));
            loadData(); 
            console.log(`Data saved for key: ${key}`);
        } catch (e) {
            console.error(`Error saving data for key: ${key}`, e);
        }
    }

    function showMessage(title, message) {
        DOM.modalTitle.textContent = title;
        DOM.modalMessage.textContent = message;
        DOM.modal.classList.remove('hidden');
    }

    function closeModal() {
        DOM.modal.classList.add('hidden');
    }
    
    // A replacement for window.confirm()
    function customConfirm(message, onConfirm) {
        // Create a temporary confirmation modal setup
        const modalHtml = `
            <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-xl soft-shadow max-w-xs mx-auto">
                    <h3 class="text-lg font-bold mb-3 text-gray-800">Confirm Action</h3>
                    <p class="text-sm text-gray-600 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button id="confirm-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition duration-150">Cancel</button>
                        <button id="confirm-ok" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-150">Confirm</button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const confirmModal = document.getElementById('confirm-modal');

        const removeModal = () => document.body.removeChild(confirmModal);

        document.getElementById('confirm-ok').onclick = () => {
            removeModal();
            onConfirm(true);
        };

        document.getElementById('confirm-cancel').onclick = () => {
            removeModal();
            onConfirm(false);
        };
    }


    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substring(2);
    }

    function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }
    
    // Helper to convert file to Base64 string asynchronously
    const readFileAsBase64 = (file) => {
        return new Promise((resolve) => {
            if (!file) return resolve(null);
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => {
                console.error("FileReader failed.");
                resolve(null);
            }; 
            reader.readAsDataURL(file);
        });
    };

    // --- Core View Rendering ---

    function setActiveNav(view) {
        // Determine the base view (e.g., 'productForm' -> 'product') for matching nav button
        let baseView = view;
        if (view.includes('Form') || view.includes('Edit')) {
            if (view.includes('product')) baseView = 'productList';
            else if (view.includes('customer')) baseView = 'customerList';
            else if (view === 'addOrder') baseView = 'orders'; 
        } else if (view === 'addOrder' || view.includes('orders')) {
            // Updated to check for orders in general (like 'ordersList')
            baseView = 'orders';
        } else if (view === 'productList' || view === 'customerList' || view === 'reports' || view === 'dashboard') {
            baseView = view;
        }

        DOM.navButtons.forEach(btn => {
            const btnView = btn.getAttribute('data-view');
            const isActive = btnView === baseView;
            btn.classList.toggle('text-blue-600', isActive);
            btn.classList.toggle('text-gray-500', !isActive);
        });
    }

    function renderView(view, id = null) {
        loadData(); 
        DOM.content.innerHTML = ''; 

        switch (view) {
            case 'dashboard':
                DOM.title.textContent = 'Dashboard';
                renderDashboard();
                break;
            case 'productList':
                DOM.title.textContent = 'Product List';
                renderProductList();
                break;
            case 'productForm':
                DOM.title.textContent = id ? 'Edit Product' : 'Add New Product';
                renderProductForm(id);
                break;
            case 'customerList':
                DOM.title.textContent = 'Customer List';
                renderCustomerList();
                break;
            case 'customerForm':
                DOM.title.textContent = id ? 'Edit Customer' : 'Add New Customer';
                renderCustomerForm(id);
                break;
            case 'orders': // Default orders list view
                renderOrders('All');
                break;
            case 'ordersListFiltered': // Specific filtered order list view
                // This case is handled in renderOrders by the third argument which acts as the filter key
                // It should not be called directly with renderView
                console.error("ordersListFiltered should not be called directly. Use renderOrders(filterKey).");
                renderOrders('All');
                break;
            case 'addOrder':
                DOM.title.textContent = 'Add New Order';
                renderAddOrderForm();
                break;
            case 'reports':
                DOM.title.textContent = 'Reports & Export';
                renderReports();
                break;
            default:
                renderDashboard();
        }
        setActiveNav(view);
    }

    // --- Dashboard View ---

    function renderDashboard() {
        const totalSales = data.orders.filter(o => o.status === 'Delivered').reduce((sum, order) => sum + parseFloat(order.amount || 0), 0);
        const deliveredCount = data.orders.filter(o => o.status === 'Delivered').length;
        // Count for Pending and Processing
        const pendingCount = data.orders.filter(o => o.status === 'Pending' || o.status === 'Processing').length; 

        const productSales = data.orders.reduce((acc, order) => {
            const product = data.products.find(p => p.id === order.productId);
            if (product) {
                acc[product.name] = (acc[product.name] || 0) + 1;
            }
            return acc;
        }, {});

        const topProducts = Object.entries(productSales)
            .sort(([, countA], [, countB]) => countB - countA)
            .slice(0, 3);

        // Updated cardStyle to include interactivity classes
        const cardStyle = "card-bg p-4 rounded-xl soft-shadow mb-4 flex-1 cursor-pointer transform hover:scale-[1.02] active:scale-[0.98] transition-all duration-200";

        let productListHtml = '';
        if (data.products.length > 0) {
            productListHtml = `
                <div class="card-bg p-4 rounded-xl soft-shadow col-span-2 mt-4">
                    <h3 class="font-bold text-lg text-gray-700 mb-3">Recent Products Added</h3>
                    <ul class="space-y-3">
                        ${data.products.slice(0, 5).reverse().map(p => `
                            <li onclick="renderView('productForm', '${p.id}')" class="flex items-center p-3 border border-gray-100 rounded-xl card-bg soft-shadow hover:bg-gray-50 active:scale-[0.98] transition-all duration-100 cursor-pointer">
                                ${p.image ? `<img src="${p.image}" class="w-12 h-12 object-cover rounded-xl mr-3 border border-gray-200" alt="${p.name}">` : `
                                    <div class="w-12 h-12 bg-gray-200 rounded-xl mr-3 flex items-center justify-center text-gray-500 text-xs font-semibold">
                                        No Pic
                                    </div>
                                `}
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-800 truncate">${p.name} <span class="text-xs text-blue-600">(${p.size})</span></p>
                                    <p class="text-sm text-gray-600">${CURRENCY_SYMBOL}${p.price}</p>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }

        DOM.content.innerHTML = `
            <div class="grid grid-cols-2 gap-4 mb-6">
                <!-- Total Sales (Delivered Orders) - INTERACTIVE -->
                <div onclick="renderOrders('Delivered')" class="${cardStyle} bg-gradient-to-br from-blue-50 to-blue-200">
                    <p class="text-sm text-gray-600">Total Sales</p>
                    <h2 class="text-3xl font-extrabold text-blue-700 mt-1">${CURRENCY_SYMBOL}${totalSales.toFixed(2)}</h2>
                </div>
                <!-- Delivered Orders - INTERACTIVE -->
                <div onclick="renderOrders('Delivered')" class="${cardStyle} bg-gradient-to-br from-green-50 to-green-200">
                    <p class="text-sm text-gray-600">Delivered Orders</p>
                    <h2 class="text-3xl font-extrabold text-green-700 mt-1">${deliveredCount}</h2>
                </div>
                <!-- Pending & Processing Orders - INTERACTIVE -->
                <div onclick="renderOrders('Active')" class="${cardStyle} bg-gradient-to-br from-yellow-50 to-yellow-200">
                    <!-- Corrected text to match logic -->
                    <p class="text-sm text-gray-600">Pending & Processing</p>
                    <h2 class="text-3xl font-extrabold text-yellow-700 mt-1">${pendingCount}</h2>
                </div>
                <!-- Total Products - INTERACTIVE -->
                <div onclick="renderView('productList')" class="${cardStyle} bg-gradient-to-br from-pink-50 to-pink-200">
                    <p class="text-sm text-gray-600">Total Products</p>
                    <h2 class="text-3xl font-extrabold text-pink-700 mt-1">${data.products.length}</h2>
                </div>
            </div>

            <div class="card-bg p-4 rounded-xl soft-shadow col-span-2">
                <h3 class="font-bold text-lg text-gray-700 mb-3">Top Products Sold</h3>
                <ul class="space-y-2">
                    ${topProducts.length > 0 ? topProducts.map(([name, count], index) => `
                        <li class="flex justify-between items-center text-gray-600">
                            <span class="font-medium truncate">${index + 1}. ${name}</span>
                            <span class="bg-gray-100 text-sm font-semibold px-2 py-0.5 rounded-full">${count} sales</span>
                        </li>
                    `).join('') : '<li class="text-sm text-gray-500">No sales data yet.</li>'}
                </ul>
            </div>
            
            ${productListHtml}
        `;
    }

    // --- LIST VIEWS (Products & Customers) ---

    function renderProductList() {
        DOM.content.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">${data.products.length} Products Found</h2>
                <button onclick="renderView('productForm')" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-semibold soft-shadow hover:bg-blue-700 transition duration-150 flex items-center">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Add New
                </button>
            </div>
            <ul class="space-y-3 scroll-list max-h-[70vh] overflow-y-auto">
                ${data.products.length > 0 ? data.products.reverse().map(p => `
                    <li onclick="renderView('productForm', '${p.id}')" class="flex items-center p-3 border border-gray-200 rounded-xl card-bg soft-shadow hover:bg-gray-50 active:scale-[0.99] transition-all duration-100 cursor-pointer">
                        ${p.image ? `<img src="${p.image}" class="w-16 h-16 object-cover rounded-lg mr-4 border border-gray-200" alt="${p.name}">` : `
                            <div class="w-16 h-16 bg-gray-100 rounded-lg mr-4 flex items-center justify-center text-gray-500 text-xs font-semibold">
                                No Pic
                            </div>
                        `}
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-gray-800 truncate">${p.name}</p>
                            <p class="text-sm text-gray-600 truncate">${p.size || 'N/A'} &bull; ${CURRENCY_SYMBOL}${p.price}</p>
                            <p class="text-xs text-gray-400">Added: ${formatDate(p.dateAdded)}</p>
                        </div>
                        <span class="text-sm text-blue-500 font-semibold ml-2">Edit &gt;</span>
                    </li>
                `).join('') : '<p class="card-bg p-4 rounded-xl text-center text-gray-500">No products added yet. Click "Add New" to get started!</p>'}
            </ul>
        `;
    }

    function renderCustomerList() {
        DOM.content.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">${data.customers.length} Customers Found</h2>
                <button onclick="renderView('customerForm')" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-semibold soft-shadow hover:bg-blue-700 transition duration-150 flex items-center">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                    Add New
                </button>
            </div>
            <ul class="space-y-3 scroll-list max-h-[70vh] overflow-y-auto">
                ${data.customers.length > 0 ? data.customers.reverse().map(c => `
                    <li onclick="renderView('customerForm', '${c.id}')" class="flex items-center p-3 border border-gray-200 rounded-xl card-bg soft-shadow hover:bg-gray-50 active:scale-[0.99] transition-all duration-100 cursor-pointer">
                        <div class="w-16 h-16 bg-blue-100 rounded-lg mr-4 flex items-center justify-center text-blue-600 text-xl font-bold">
                            ${c.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-gray-800 truncate">${c.name}</p>
                            <p class="text-sm text-gray-600 truncate">${c.phone || c.email || 'No contact info'}</p>
                            <p class="text-xs text-gray-400">Orders: ${data.orders.filter(o => o.customerId === c.id).length}</p>
                            ${c.trackingId ? `<p class="text-xs text-purple-500 font-semibold mt-1">ID: ${c.trackingId}</p>` : ''}
                        </div>
                        <span class="text-sm text-blue-500 font-semibold ml-2">Edit &gt;</span>
                    </li>
                `).join('') : '<p class="card-bg p-4 rounded-xl text-center text-gray-500">No customers added yet. Click "Add New" to get started!</p>'}
            </ul>
        `;
    }

    // --- FORM VIEWS ---

    function renderProductForm(id) {
        const product = data.products.find(p => p.id === id);
        
        DOM.content.innerHTML = `
            <div class="card-bg p-5 rounded-2xl soft-shadow">
                <form id="product-form">
                    <!-- Product Image Upload -->
                    <div class="mb-5 text-center">
                        <label for="product-image-file" class="cursor-pointer">
                            <div class="w-32 h-32 mx-auto mb-3 bg-gray-100 rounded-xl flex items-center justify-center border-2 border-dashed border-gray-300 relative overflow-hidden">
                                ${product?.image ? `<img id="preview-image" src="${product.image}" class="w-full h-full object-cover" alt="Product Image">` : `
                                    <div id="no-image-placeholder" class="text-gray-500 text-center p-2">
                                        <svg class="w-8 h-8 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        <span class="text-xs font-semibold">Upload Photo</span>
                                    </div>
                                `}
                            </div>
                        </label>
                        <input type="file" id="product-image-file" class="file-input" accept="image/*">
                        ${product?.image ? `<button type="button" onclick="removeProductImage()" class="text-red-500 text-sm mt-1 hover:text-red-700 transition duration-150">Remove Image</button>` : ''}
                    </div>

                    <!-- Hidden ID field -->
                    <input type="hidden" id="product-id" value="${product?.id || ''}">
                    
                    <div class="mb-4">
                        <label for="product-name" class="block text-sm font-medium text-gray-700 mb-1">Product Name *</label>
                        <input type="text" id="product-name" value="${product?.name || ''}" placeholder="Product Name (e.g., Hoodie, Mug)" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150" required>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="product-price" class="block text-sm font-medium text-gray-700 mb-1">Price (${CURRENCY_SYMBOL}) *</label>
                            <input type="number" id="product-price" value="${product?.price || ''}" placeholder="999.00" step="0.01" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150" required>
                        </div>
                        <div>
                            <label for="product-size" class="block text-sm font-medium text-gray-700 mb-1">Size / Variant</label>
                            <input type="text" id="product-size" value="${product?.size || ''}" placeholder="e.g., L, 10oz, Standard" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150">
                        </div>
                    </div>

                    <div class="mb-6">
                        <label for="product-description" class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
                        <textarea id="product-description" rows="3" placeholder="Brief description of the product" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150">${product?.description || ''}</textarea>
                    </div>

                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold soft-shadow hover:bg-green-700 transition duration-150 active:scale-[0.99]">
                        ${id ? 'Save Changes' : 'Add Product'}
                    </button>
                    
                    ${id ? `<button type="button" onclick="deleteProduct('${id}')" class="w-full bg-red-500 text-white py-3 mt-3 rounded-xl font-bold soft-shadow hover:bg-red-600 transition duration-150 active:scale-[0.99]">
                        Delete Product
                    </button>` : ''}
                </form>
            </div>
        `;

        document.getElementById('product-form').onsubmit = saveProduct;
        document.getElementById('product-image-file').onchange = previewProductImage;
    }

    function renderCustomerForm(id) {
        const customer = data.customers.find(c => c.id === id);
        
        DOM.content.innerHTML = `
            <div class="card-bg p-5 rounded-2xl soft-shadow">
                <form id="customer-form">
                    <!-- Hidden ID field -->
                    <input type="hidden" id="customer-id" value="${customer?.id || ''}">
                    
                    <div class="mb-4">
                        <label for="customer-name" class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                        <input type="text" id="customer-name" value="${customer?.name || ''}" placeholder="Customer Name" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150" required>
                    </div>

                    <!-- NEW TRACKING ID FIELD -->
                    <div class="mb-4">
                        <label for="customer-tracking-id" class="block text-sm font-medium text-gray-700 mb-1">External Tracking ID (Optional)</label>
                        <input type="text" id="customer-tracking-id" value="${customer?.trackingId || ''}" placeholder="e.g., CRM-100293, Shopify-Cust-XYZ" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150">
                    </div>

                    <div class="mb-4">
                        <label for="customer-phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input type="tel" id="customer-phone" value="${customer?.phone || ''}" placeholder="(123) 456-7890" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150">
                    </div>

                    <div class="mb-4">
                        <label for="customer-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                        <input type="email" id="customer-email" value="${customer?.email || ''}" placeholder="email@example.com" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150">
                    </div>

                    <div class="mb-6">
                        <label for="customer-address" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                        <textarea id="customer-address" rows="3" placeholder="Street, City, Zip" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150">${customer?.address || ''}</textarea>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold soft-shadow hover:bg-blue-700 transition duration-150 active:scale-[0.99]">
                        ${id ? 'Save Changes' : 'Add Customer'}
                    </button>

                    ${id ? `<button type="button" onclick="deleteCustomer('${id}')" class="w-full bg-red-500 text-white py-3 mt-3 rounded-xl font-bold soft-shadow hover:bg-red-600 transition duration-150 active:scale-[0.99]">
                        Delete Customer
                    </button>` : ''}
                </form>
            </div>
        `;

        document.getElementById('customer-form').onsubmit = saveCustomer;
    }
    
    function renderAddOrderForm() {
        const hasProducts = data.products.length > 0;
        const hasCustomers = data.customers.length > 0;

        // Populate customer options
        const customerOptions = data.customers.map(c => 
            `<option value="${c.id}">${c.name} (${c.phone || c.email || 'N/A'})</option>`
        ).join('');

        // Populate product options
        const productOptions = data.products.map(p => 
            `<option value="${p.id}" data-price="${p.price}">${p.name} (${CURRENCY_SYMBOL}${p.price})</option>`
        ).join('');
        
        // Populate delivery date options (Today + 1 week)
        const dateOptions = generateDeliveryDateOptions();

        if (!hasProducts || !hasCustomers) {
            DOM.content.innerHTML = `
                <div class="card-bg p-5 rounded-2xl soft-shadow mb-4">
                    <h2 class="text-xl font-bold text-gray-800 mb-3">Setup Required</h2>
                    <p class="text-gray-600 mb-4">You need to add both products and customers before creating an order.</p>
                    ${!hasCustomers ? `<button onclick="renderView('customerForm')" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold soft-shadow mb-3 hover:bg-blue-600">Add Customer Now</button>` : ''}
                    ${!hasProducts ? `<button onclick="renderView('productForm')" class="w-full bg-green-500 text-white py-3 rounded-xl font-bold soft-shadow hover:bg-green-600">Add Product Now</button>` : ''}
                </div>
            `;
            return;
        }

        DOM.content.innerHTML = `
            <div class="card-bg p-5 rounded-2xl soft-shadow">
                <form id="order-form">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">New Order Details</h2>
                    <div class="mb-4">
                        <label for="order-customer" class="block text-sm font-medium text-gray-700 mb-1">Customer *</label>
                        <select id="order-customer" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150" required>
                            <option value="">Select Customer...</option>
                            ${customerOptions}
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="order-product" class="block text-sm font-medium text-gray-700 mb-1">Product *</label>
                        <select id="order-product" onchange="calculateTotal()" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150" required>
                            <option value="">Select Product...</option>
                            ${productOptions}
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="order-quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity *</label>
                        <input type="number" id="order-quantity" value="1" min="1" oninput="calculateTotal()" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150" required>
                    </div>
                    
                    <div class="mb-4">
                        <label for="order-delivery-date" class="block text-sm font-medium text-gray-700 mb-1">Target Delivery Date (Optional)</label>
                        <select id="order-delivery-date" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150">
                            <option value="">No Target Date</option>
                            ${dateOptions}
                        </select>
                    </div>

                    <div class="mb-6">
                        <label for="order-notes" class="block text-sm font-medium text-gray-700 mb-1">Notes (Optional)</label>
                        <textarea id="order-notes" rows="3" placeholder="Delivery instructions, special requests" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150"></textarea>
                    </div>
                    
                    <div class="flex justify-between items-center bg-gray-100 p-4 rounded-xl soft-shadow mb-6">
                        <span class="text-lg font-bold text-gray-700">Total Amount:</span>
                        <span id="order-total-amount" class="text-2xl font-extrabold text-blue-600">${CURRENCY_SYMBOL}0.00</span>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold soft-shadow hover:bg-blue-700 transition duration-150 active:scale-[0.99]">
                        Place Order
                    </button>
                    <button type="button" onclick="renderOrders('All')" class="w-full bg-gray-200 text-gray-700 py-3 mt-3 rounded-xl font-bold soft-shadow hover:bg-gray-300 transition duration-150 active:scale-[0.99]">
                        Cancel / Back to Orders List
                    </button>
                </form>
            </div>
        `;

        document.getElementById('order-form').onsubmit = saveOrder;
        calculateTotal(); // Initial calculation
    }

    function renderReports() {
        DOM.content.innerHTML = `
            <!-- Order Status Breakdown Card -->
            <div class="card-bg p-5 rounded-2xl soft-shadow mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Order Status Breakdown</h2>
                ${renderStatusBreakdown()}
            </div>

            <!-- Data Backup & Restore Card -->
            <div class="card-bg p-5 rounded-2xl soft-shadow mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">Data Backup & Restore</h2>
                <p class="text-sm text-gray-600 mb-5">
                    JSON is the recommended format for backup, as it includes product photos (Base64) and is easy to store on services like GitHub.
                </p>

                <h3 class="font-bold text-lg text-gray-700 mb-3">Export Data (Backup)</h3>
                <button onclick="exportData('json')" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold soft-shadow mb-3 hover:bg-red-700 transition duration-150 flex items-center justify-center active:scale-[0.99]">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Export All as JSON (Recommended)
                </button>
                <button onclick="exportData('csv')" class="w-full bg-orange-500 text-white py-3 rounded-xl font-bold soft-shadow mb-6 hover:bg-orange-600 transition duration-150 flex items-center justify-center active:scale-[0.99]">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 2H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Export Orders/Customers as CSV
                </button>

                <h3 class="font-bold text-lg text-gray-700 mb-3">Import Data (Restore)</h3>
                <p class="text-sm text-red-600 mb-3 font-semibold">
                    WARNING: Importing a file will completely OVERWRITE your current data!
                </p>
                
                <label for="import-json-file" class="file-input-label">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    Select JSON Restore File
                </label>
                <input type="file" id="import-json-file" class="file-input" accept="application/json" onchange="importData(this.files[0])">
            </div>
        `;
    }
    
    // --- Data Handlers ---

    // Product Handlers
    async function saveProduct(event) {
        event.preventDefault();
        
        const id = document.getElementById('product-id').value;
        const name = document.getElementById('product-name').value.trim();
        const price = parseFloat(document.getElementById('product-price').value).toFixed(2);
        const size = document.getElementById('product-size').value.trim();
        const description = document.getElementById('product-description').value.trim();
        const imageFile = document.getElementById('product-image-file').files[0];
        const currentProduct = data.products.find(p => p.id === id);

        if (!name || isNaN(price)) {
            showMessage("Error", "Product Name and a valid Price are required.");
            return;
        }
        
        // Handle image promise
        let imageBase64 = currentProduct?.image || null;
        if (imageFile) {
            imageBase64 = await readFileAsBase64(imageFile);
        } else if (currentProduct?.image && !document.getElementById('preview-image')) {
            // Check if the image was intentionally removed
            imageBase64 = null;
        }

        const newProduct = {
            id: id || generateId(),
            name: name,
            price: price,
            size: size,
            description: description,
            image: imageBase64,
            dateAdded: currentProduct?.dateAdded || Date.now(),
        };

        if (id) {
            // Edit existing
            data.products = data.products.map(p => p.id === id ? newProduct : p);
            showMessage("Success", `Product "${name}" updated successfully.`);
        } else {
            // Add new
            data.products.push(newProduct);
            showMessage("Success", `Product "${name}" added successfully.`);
        }
        
        saveData(STORAGE_KEYS.PRODUCTS, data.products);
        renderView('productList');
    }
    
    function deleteProduct(id) {
        customConfirm("Are you sure you want to permanently delete this product? This cannot be undone.", (confirmed) => {
            if (confirmed) {
                const product = data.products.find(p => p.id === id);
                data.products = data.products.filter(p => p.id !== id);
                data.orders = data.orders.filter(o => o.productId !== id); // Remove associated orders
                
                saveData(STORAGE_KEYS.PRODUCTS, data.products);
                saveData(STORAGE_KEYS.ORDERS, data.orders);
                
                showMessage("Deleted", `Product "${product.name}" and associated orders have been deleted.`);
                renderView('productList');
            }
        });
    }

    // Customer Handlers
    function saveCustomer(event) {
        event.preventDefault();
        
        const id = document.getElementById('customer-id').value;
        const name = document.getElementById('customer-name').value.trim();
        const trackingId = document.getElementById('customer-tracking-id').value.trim(); // NEW FIELD
        const phone = document.getElementById('customer-phone').value.trim();
        const email = document.getElementById('customer-email').value.trim();
        const address = document.getElementById('customer-address').value.trim();
        const currentCustomer = data.customers.find(c => c.id === id);

        if (!name) {
            showMessage("Error", "Customer Name is required.");
            return;
        }

        const newCustomer = {
            id: id || generateId(),
            name: name,
            trackingId: trackingId, // ADDED FIELD
            phone: phone,
            email: email,
            address: address,
            dateAdded: currentCustomer?.dateAdded || Date.now(),
        };

        if (id) {
            // Edit existing
            data.customers = data.customers.map(c => c.id === id ? newCustomer : c);
            showMessage("Success", `Customer "${name}" updated successfully.`);
        } else {
            // Add new
            data.customers.push(newCustomer);
            showMessage("Success", `Customer "${name}" added successfully.`);
        }
        
        saveData(STORAGE_KEYS.CUSTOMERS, data.customers);
        renderView('customerList');
    }
    
    function deleteCustomer(id) {
        customConfirm("Are you sure you want to permanently delete this customer? Associated orders will also be deleted.", (confirmed) => {
            if (confirmed) {
                const customer = data.customers.find(c => c.id === id);
                data.customers = data.customers.filter(c => c.id !== id);
                data.orders = data.orders.filter(o => o.customerId !== id); // Remove associated orders
                
                saveData(STORAGE_KEYS.CUSTOMERS, data.customers);
                saveData(STORAGE_KEYS.ORDERS, data.orders);
                
                showMessage("Deleted", `Customer "${customer.name}" and associated orders have been deleted.`);
                renderView('customerList');
            }
        });
    }

    // Order Handlers
    function calculateTotal() {
        const productSelect = document.getElementById('order-product');
        const quantityInput = document.getElementById('order-quantity');
        const totalSpan = document.getElementById('order-total-amount');

        if (!productSelect || !quantityInput || !totalSpan) return;

        const selectedOption = productSelect.options[productSelect.selectedIndex];
        const price = parseFloat(selectedOption?.getAttribute('data-price') || 0);
        const quantity = parseInt(quantityInput.value || 0);

        const total = price * quantity;
        totalSpan.textContent = `${CURRENCY_SYMBOL}${total.toFixed(2)}`;
    }

    function saveOrder(event) {
        event.preventDefault();

        const customerId = document.getElementById('order-customer').value;
        const productId = document.getElementById('order-product').value;
        const quantity = parseInt(document.getElementById('order-quantity').value);
        const deliveryDate = document.getElementById('order-delivery-date').value;
        const notes = document.getElementById('order-notes').value.trim();
        // Remove CURRENCY_SYMBOL before saving
        const amount = document.getElementById('order-total-amount').textContent.replace(CURRENCY_SYMBOL, ''); 

        if (!customerId || !productId || quantity <= 0) {
            showMessage("Error", "Please select a Customer, Product, and enter a valid Quantity.");
            return;
        }

        const newOrder = {
            id: generateId(),
            customerId: customerId,
            productId: productId,
            quantity: quantity,
            amount: amount,
            status: 'Pending', // Default status for new order
            notes: notes,
            datePlaced: Date.now(),
            targetDate: deliveryDate ? new Date(deliveryDate).getTime() : null,
        };

        data.orders.push(newOrder);
        saveData(STORAGE_KEYS.ORDERS, data.orders);

        showMessage("Order Placed", `New order for ${CURRENCY_SYMBOL}${amount} has been placed successfully and is marked as Pending.`);
        renderOrders('Pending'); // Redirect to the order list, filtered by the newly created status.
    }
    
    // --- Utility Functions for Forms and Reporting ---

    // Image preview for Product Form
    function previewProductImage(event) {
        const file = event.target.files[0];
        const preview = document.getElementById('preview-image');
        const placeholder = document.getElementById('no-image-placeholder');
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                if (!preview) {
                    const img = document.createElement('img');
                    img.id = 'preview-image';
                    img.className = 'w-full h-full object-cover';
                    img.alt = 'Product Image';
                    document.querySelector('label[for="product-image-file"] div').appendChild(img);
                }
                document.getElementById('preview-image').src = e.target.result;
                if (placeholder) placeholder.style.display = 'none';
                
                // Add remove button if it doesn't exist
                if (!document.querySelector('button[onclick="removeProductImage()"]')) {
                    const removeButton = document.createElement('button');
                    removeButton.type = 'button';
                    removeButton.onclick = removeProductImage;
                    removeButton.className = 'text-red-500 text-sm mt-1 hover:text-red-700 transition duration-150';
                    removeButton.textContent = 'Remove Image';
                    document.querySelector('.mb-5.text-center').appendChild(removeButton);
                }
            };
            reader.readAsDataURL(file);
        }
    }
    
    // Image removal for Product Form
    function removeProductImage() {
        const imageFile = document.getElementById('product-image-file');
        const preview = document.getElementById('preview-image');
        
        // Clear file input value
        imageFile.value = ''; 
        
        // Remove the image element and show placeholder (if placeholder exists or create it)
        if (preview) {
            preview.remove();
        }
        
        let placeholder = document.getElementById('no-image-placeholder');
        if (!placeholder) {
            document.querySelector('label[for="product-image-file"] div').innerHTML = `
                <div id="no-image-placeholder" class="text-gray-500 text-center p-2">
                    <svg class="w-8 h-8 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span class="text-xs font-semibold">Upload Photo</span>
                </div>
            `;
        } else {
            placeholder.style.display = 'block';
        }

        // Remove the "Remove Image" button
        const removeButton = document.querySelector('button[onclick="removeProductImage()"]');
        if (removeButton) {
            removeButton.remove();
        }
    }

    function generateDeliveryDateOptions() {
        const options = [];
        const today = new Date();
        // Generate options for the next 7 days
        for (let i = 1; i <= 7; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);
            const dateString = date.toISOString().split('T')[0];
            const displayDate = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            options.push(`<option value="${dateString}">${displayDate}</option>`);
        }
        return options.join('');
    }

    function renderStatusBreakdown() {
        const counts = {
            Delivered: data.orders.filter(o => o.status === 'Delivered').length,
            Processing: data.orders.filter(o => o.status === 'Processing').length,
            Pending: data.orders.filter(o => o.status === 'Pending').length,
            Cancelled: data.orders.filter(o => o.status === 'Cancelled').length,
        };

        return `
            <div class="space-y-3">
                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                    <span class="text-gray-700">Delivered:</span>
                    <span class="font-bold text-green-600">${counts.Delivered}</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                    <span class="text-gray-700">Processing:</span>
                    <span class="font-bold text-yellow-600">${counts.Processing}</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                    <span class="text-gray-700">Pending:</span>
                    <span class="font-bold text-blue-600">${counts.Pending}</span>
                </div>
                <div class="flex justify-between items-center py-2">
                    <span class="text-gray-700">Cancelled:</span>
                    <span class="font-bold text-red-600">${counts.Cancelled}</span>
                </div>
            </div>
        `;
    }

    // --- Import/Export Handlers (Reports View) ---

    function exportData(format) {
        const exportData = {
            products: data.products,
            customers: data.customers,
            orders: data.orders
        };
        
        let fileContent, fileName, mimeType;

        if (format === 'json') {
            fileContent = JSON.stringify(exportData, null, 2);
            fileName = `ordermanager_backup_${new Date().toISOString().split('T')[0]}.json`;
            mimeType = 'application/json';
        } else if (format === 'csv') {
            // Simple CSV export for Orders and Customers
            const ordersCsv = [
                "Order ID,Date Placed,Customer Name,Product Name,Quantity,Amount,Status",
                ...data.orders.map(order => {
                    const customer = data.customers.find(c => c.id === order.customerId);
                    const product = data.products.find(p => p.id === order.productId);
                    return `"${order.id}","${formatDate(order.datePlaced)}","${customer?.name || 'N/A'}","${product?.name || 'N/A'}","${order.quantity}","${order.amount}","${order.status}"`;
                })
            ].join('\n');
            
            fileContent = ordersCsv;
            fileName = `ordermanager_orders_customers_${new Date().toISOString().split('T')[0]}.csv`;
            mimeType = 'text/csv';
        }

        const blob = new Blob([fileContent], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showMessage("Export Successful", `Data exported as ${fileName}.`);
    }

    function importData(file) {
        if (!file) {
            showMessage("Import Failed", "Please select a JSON file to import.");
            return;
        }

        customConfirm("WARNING: Are you absolutely sure you want to import data? This will REPLACE ALL existing Products, Customers, and Orders.", (confirmed) => {
            if (confirmed) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (importedData.products && importedData.customers && importedData.orders) {
                            // Simple validation: check if keys exist
                            data.products = importedData.products;
                            data.customers = importedData.customers;
                            data.orders = importedData.orders;
                            
                            // Save and refresh
                            saveData(STORAGE_KEYS.PRODUCTS, data.products);
                            saveData(STORAGE_KEYS.CUSTOMERS, data.customers);
                            saveData(STORAGE_KEYS.ORDERS, data.orders);

                            showMessage("Import Successful", "All data has been successfully restored from the file.");
                            renderView('dashboard'); // Go back to dashboard after import
                        } else {
                            throw new Error("Missing required data keys (products, customers, orders).");
                        }
                    } catch (error) {
                        console.error("Import error:", error);
                        showMessage("Import Error", `Failed to read or parse the file. Ensure it is a valid backup JSON. Error: ${error.message}`);
                    }
                };
                reader.onerror = function() {
                    showMessage("Import Error", "An error occurred while reading the file.");
                };
                reader.readAsText(file);
            }
        });
        
        // Clear the file input after use
        document.getElementById('import-json-file').value = '';
    }

    // --- Order History View ---
    
    // Helper to get status tag color
    function getStatusColor(status) {
        switch (status) {
            case 'Delivered': return 'bg-green-100 text-green-700';
            case 'Processing': return 'bg-yellow-100 text-yellow-700';
            case 'Cancelled': return 'bg-red-100 text-red-700';
            case 'Pending': 
            default: return 'bg-blue-100 text-blue-700';
        }
    }

    // Function to replace status tag with a selector
    function openStatusSelector(orderId, currentStatus, currentFilter) {
        const statusContainer = document.getElementById(`status-container-${orderId}`);
        if (!statusContainer) return;

        // Create the select element
        const select = document.createElement('select');
        select.id = `status-select-${orderId}`;
        select.className = 'w-full p-1 border border-gray-300 rounded-lg text-sm font-semibold focus:ring-blue-500 focus:border-blue-500';
        select.onchange = (event) => {
            updateOrderStatus(orderId, event.target.value, currentFilter);
            select.remove(); // Remove selector after change
        };

        // Populate options
        STATUS_OPTIONS.forEach(status => {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status;
            if (status === currentStatus) {
                option.selected = true;
            }
            select.appendChild(option);
        });

        // Replace the tag with the selector and ensure the selector is visible
        statusContainer.innerHTML = '';
        statusContainer.appendChild(select);
        select.focus(); // Focus the dropdown for immediate use
    }


    // Function to generate action buttons (simplified as status is now clickable)
    function orderActionButtons(order) {
        // Only include the delete button as status change is now handled by clicking the status tag
        return `
            <button onclick="deleteOrder('${order.id}')" title="Delete Order" class="bg-gray-200 text-red-600 p-2 rounded-full hover:bg-gray-300 transition duration-150 soft-shadow active:scale-95">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
        `;
    }


    // New view function for Orders
    function renderOrders(filter = 'All') {
        // Updated header logic to reflect filters
        if (filter === 'Active') {
            DOM.title.textContent = 'Active Orders (Pending & Processing)';
        } else if (filter !== 'All') {
            DOM.title.textContent = `${filter} Orders`;
        } else {
            DOM.title.textContent = 'Order History';
        }

        const statusCounts = {
            All: data.orders.length,
            Pending: data.orders.filter(o => o.status === 'Pending').length,
            Processing: data.orders.filter(o => o.status === 'Processing').length,
            Delivered: data.orders.filter(o => o.status === 'Delivered').length,
            Cancelled: data.orders.filter(o => o.status === 'Cancelled').length,
        };

        let filteredOrders = data.orders.slice().reverse(); // Reverse for most recent first
        
        // Logic to handle new 'Active' filter
        if (filter === 'Active') {
            filteredOrders = filteredOrders.filter(o => o.status === 'Pending' || o.status === 'Processing');
        } else if (filter !== 'All') {
            filteredOrders = filteredOrders.filter(o => o.status === filter);
        }
        
        // Add Active count dynamically if needed
        statusCounts.Active = statusCounts.Pending + statusCounts.Processing;

        const filterButton = (status, label) => {
            const isActive = status === filter;
            const count = statusCounts[status] || 0;
            return `<button onclick="renderOrders('${status}')" class="px-4 py-1.5 text-sm font-semibold rounded-full transition duration-150 ${isActive ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}">
                ${label} (${count})
            </button>`;
        };


        DOM.content.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">${filteredOrders.length} Orders Listed</h2>
                <button onclick="renderView('addOrder')" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-semibold soft-shadow hover:bg-blue-700 transition duration-150 flex items-center">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    New Order
                </button>
            </div>

            <!-- Filter Buttons -->
            <div class="flex space-x-2 overflow-x-auto pb-4 scroll-list mb-4">
                ${filterButton('All', 'All')}
                ${filterButton('Active', 'Active')}
                ${filterButton('Pending', 'Pending')}
                ${filterButton('Processing', 'Processing')}
                ${filterButton('Delivered', 'Delivered')}
                ${filterButton('Cancelled', 'Cancelled')}
            </div>

            <!-- Order List -->
            <ul class="space-y-3 scroll-list max-h-[65vh] overflow-y-auto">
                ${filteredOrders.length > 0 ? filteredOrders.map(order => {
                    const customer = data.customers.find(c => c.id === order.customerId);
                    const product = data.products.find(p => p.id === order.productId);
                    const targetDateStr = order.targetDate ? formatDate(order.targetDate) : 'No Target Date';

                    return `
                        <li class="p-4 rounded-xl card-bg soft-shadow border border-gray-200">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1 min-w-0">
                                    <p class="font-bold text-lg text-gray-800 truncate">${product?.name || 'Unknown Product'} x ${order.quantity}</p>
                                    <p class="text-xs text-gray-500">Customer: ${customer?.name || 'N/A'}</p>
                                    <p class="text-xs text-gray-500">Placed: ${formatDate(order.datePlaced)}</p>
                                </div>
                                <span class="text-xl font-extrabold text-blue-600 ml-2">${CURRENCY_SYMBOL}${order.amount}</span>
                            </div>
                            
                            <div class="flex items-center justify-between mt-2">
                                <div>
                                    <!-- Status Tag is now clickable to change status -->
                                    <div id="status-container-${order.id}">
                                        <span 
                                            onclick="openStatusSelector('${order.id}', '${order.status}', '${filter}')" 
                                            title="Click to change status manually"
                                            class="text-xs font-semibold px-2 py-0.5 rounded-full ${getStatusColor(order.status)} cursor-pointer hover:shadow-md transition duration-150 active:scale-[0.98]"
                                        >
                                            ${order.status}
                                        </span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Delivery: ${targetDateStr}</p>
                                </div>
                                <div class="flex space-x-2">
                                    ${orderActionButtons(order)}
                                </div>
                            </div>
                        </li>
                    `;
                }).join('') : '<p class="card-bg p-4 rounded-xl text-center text-gray-500">No orders match the current filter. Click "New Order" to add one.</p>'}
            </ul>
        `;
    }

    function updateOrderStatus(id, newStatus, currentFilter) {
        const orderIndex = data.orders.findIndex(o => o.id === id);
        if (orderIndex > -1) {
            data.orders[orderIndex].status = newStatus;
            saveData(STORAGE_KEYS.ORDERS, data.orders);
            showMessage("Order Updated", `Order ${id.substring(0, 8)}... status updated to ${newStatus}.`);
            
            // Re-render the current view, maintaining the filter if possible
            if (currentFilter === 'All' || currentFilter === newStatus || currentFilter === 'Active' && (newStatus === 'Pending' || newStatus === 'Processing')) {
                renderOrders(currentFilter);
            } else if (currentFilter === 'Active' && (newStatus === 'Delivered' || newStatus === 'Cancelled')) {
                // If an active order moves to a non-active state, switch view to All
                renderOrders('All');
            } else {
                 renderOrders(currentFilter); // Re-render the existing filtered list
            }
        }
    }
    
    function deleteOrder(id) {
        customConfirm("Are you sure you want to delete this order permanently? This action cannot be reversed.", (confirmed) => {
            if (confirmed) {
                data.orders = data.orders.filter(o => o.id !== id);
                saveData(STORAGE_KEYS.ORDERS, data.orders);
                showMessage("Order Deleted", `Order ${id.substring(0, 8)}... has been permanently deleted.`);
                renderOrders('All'); 
            }
        });
    }


    // --- Initialization and Event Listeners ---

    // Function to handle the navigation clicks
    DOM.navButtons.forEach(button => {
        button.addEventListener('click', () => {
            const view = button.getAttribute('data-view');
            // Check if the target view is the list of orders
            if (view === 'orders') {
                renderOrders('All'); 
            } else {
                renderView(view);
            }
        });
    });
    
    // Initial load
    renderView('dashboard'); 
    
/* ====== Safe Online Restore from GitHub ======
   Reads backup.json from your public repo
   and fills localStorage when the app loads
================================================ */

async function restoreBackup() {
  try {
    const url =
      "https://raw.githubusercontent.com/manuelchakma/Order.Manager/main/backup.json";
    const res = await fetch(url);
    if (!res.ok) throw new Error("No backup file found online.");

    const data = await res.json();

    localStorage.setItem(
      "order_manager_products",
      JSON.stringify(data.products || [])
    );
    localStorage.setItem(
      "order_manager_customers",
      JSON.stringify(data.customers || [])
    );
    localStorage.setItem(
      "order_manager_orders",
      JSON.stringify(data.orders || [])
    );

    console.log("✅ Data restored from GitHub");
    if (typeof showMessage === "function") {
      showMessage("Restore Complete", "Data loaded from GitHub backup.");
    }
  } catch (err) {
    console.error("❌ Restore failed:", err);
    if (typeof showMessage === "function") {
      showMessage("Restore Failed", "Could not fetch data from GitHub.");
    }
  }
}

// Automatically try to restore data when app opens (needs internet)
window.addEventListener("load", restoreBackup);
</script>
</body>
</html>



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        /* Custom soft shadow */
        .soft-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
        .card-bg { background-color: #ffffff; }
        .main-content { padding-bottom: 72px; /* Space for the fixed bottom nav */ }
        .nav-btn {
            @apply flex flex-col items-center justify-center p-1 text-sm transition-colors duration-200;
        }
        .file-input-label {
            @apply flex items-center justify-center bg-gray-100 text-gray-700 py-2 rounded-lg cursor-pointer hover:bg-gray-200 transition duration-150 border border-gray-300;
        }
        .file-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
        /* Custom scrollbar for mobile feel */
        .scroll-list::-webkit-scrollbar {
            display: none;
        }
        .scroll-list {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body>

    <div id="app" class="max-w-md mx-auto min-h-screen relative soft-shadow">

        <!-- Header -->
        <header class="bg-white p-4 soft-shadow sticky top-0 z-10">
            <h1 id="header-title" class="text-xl font-bold text-gray-800">Dashboard</h1>
        </header>

        <!-- --- DEBUG MESSAGE - THIS WILL DISAPPEAR IF JS RUNS --- -->
        <!-- Note: If you see this, the JS code is not running! -->
        <div id="debug-error" class="p-4 bg-red-100 border-l-4 border-red-500 text-red-700 m-4 rounded-lg soft-shadow">
            <p class="font-bold">Initialization Error</p>
            <p class="text-sm">The application's logic is not starting. This usually means the file name is wrong (must be index.html) or the script tags were corrupted during copy/paste. Please refresh the page or check the file content on GitHub.</p>
        </div>
        <!-- -------------------------------------------------------- -->

        <!-- Main Content Area -->
        <div id="view-content" class="p-4 main-content">
            <!-- Content will be injected here by JavaScript -->
        </div>

        <!-- Fixed Bottom Navigation Bar -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-200 z-20 soft-shadow">
            <div class="flex justify-around h-16">
                <button class="nav-btn text-blue-600 active-nav" data-view="dashboard">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2m-7 7h3m-7 7h3a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1h3"></path></svg>
                    <span class="text-xs">Home</span>
                </button>
                <button class="nav-btn text-gray-500 hover:text-blue-600" data-view="productList">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h.01"></path></svg>
                    <span class="text-xs">Products</span>
                </button>
                <button class="nav-btn text-gray-500 hover:text-blue-600" data-view="orders">
                    <!-- Changed data-view from addOrder to orders for list view -->
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5h6"></path></svg>
                    <span class="text-xs">Orders</span>
                </button>
                <button class="nav-btn text-gray-500 hover:text-blue-600" data-view="customerList">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    <span class="text-xs">Customers</span>
                </button>
                <button class="nav-btn text-gray-500 hover:text-blue-600" data-view="reports">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-2.414-2.414A1 1 0 0015.586 6H7a2 2 0 00-2 2v11a2 2 0 002 2z"></path></svg>
                    <span class="text-xs">Reports</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Modal for Messages/Confirmation (in place of alert/confirm) -->
    <div id="message-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl soft-shadow max-w-xs mx-auto">
            <h3 id="modal-title" class="text-lg font-bold mb-3 text-gray-800">Notification</h3>
            <p id="modal-message" class="text-sm text-gray-600 mb-4"></p>
            <button onclick="closeModal()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-150">Got It</button>
        </div>
    </div>

<script>
    // --- Global State and Utility Functions ---

    // Hides the debug message as soon as the JavaScript begins execution
    document.getElementById('debug-error').style.display = 'none';

    // Global constant for Indian Rupee symbol
    const CURRENCY_SYMBOL = 'â‚¹';

    const STATUS_OPTIONS = [
        'Pending',
        'Processing',
        'Delivered',
        'Cancelled'
    ];

    const STORAGE_KEYS = {
        PRODUCTS: 'order_manager_products',
        CUSTOMERS: 'order_manager_customers',
        ORDERS: 'order_manager_orders',
    };

    const DOM = {
        content: document.getElementById('view-content'),
        title: document.getElementById('header-title'),
        navButtons: document.querySelectorAll('.nav-btn'),
        modal: document.getElementById('message-modal'),
        modalTitle: document.getElementById('modal-title'),
        modalMessage: document.getElementById('modal-message'),
    };

    let data = {
        products: [],
        customers: [],
        orders: [],
    };

    function loadData() {
        try {
            data.products = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS) || '[]')
                .map(p => ({...p, id: p.id || generateId()})); 
            data.customers = JSON.parse(localStorage.getItem(STORAGE_KEYS.CUSTOMERS) || '[]')
                .map(c => ({...c, id: c.id || generateId()})); 
            data.orders = JSON.parse(localStorage.getItem(STORAGE_KEYS.ORDERS) || '[]');
            console.log("Data loaded successfully.");
        } catch (e) {
            console.error("Error loading data from localStorage:", e);
        }
    }

    function saveData(key, items) {
        try {
            localStorage.setItem(key, JSON.stringify(items));
            loadData(); 
            console.log(`Data saved for key: ${key}`);
        } catch (e) {
            console.error(`Error saving data for key: ${key}`, e);
        }
    }

    function showMessage(title, message) {
        DOM.modalTitle.textContent = title;
        DOM.modalMessage.textContent = message;
        DOM.modal.classList.remove('hidden');
    }

    function closeModal() {
        DOM.modal.classList.add('hidden');
    }
    
    // A replacement for window.confirm()
    function customConfirm(message, onConfirm) {
        // Create a temporary confirmation modal setup
        const modalHtml = `
            <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-xl soft-shadow max-w-xs mx-auto">
                    <h3 class="text-lg font-bold mb-3 text-gray-800">Confirm Action</h3>
                    <p class="text-sm text-gray-600 mb-4">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button id="confirm-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition duration-150">Cancel</button>
                        <button id="confirm-ok" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-150">Confirm</button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const confirmModal = document.getElementById('confirm-modal');

        const removeModal = () => document.body.removeChild(confirmModal);

        document.getElementById('confirm-ok').onclick = () => {
            removeModal();
            onConfirm(true);
        };

        document.getElementById('confirm-cancel').onclick = () => {
            removeModal();
            onConfirm(false);
        };
    }


    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substring(2);
    }

    function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }
    
    // Helper to convert file to Base64 string asynchronously
    const readFileAsBase64 = (file) => {
        return new Promise((resolve) => {
            if (!file) return resolve(null);
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => {
                console.error("FileReader failed.");
                resolve(null);
            }; 
            reader.readAsDataURL(file);
        });
    };

    // --- Core View Rendering ---

    function setActiveNav(view) {
        // Determine the base view (e.g., 'productForm' -> 'product') for matching nav button
        let baseView = view;
        if (view.includes('Form') || view.includes('Edit')) {
            if (view.includes('product')) baseView = 'productList';
            else if (view.includes('customer')) baseView = 'customerList';
            else if (view === 'addOrder') baseView = 'orders'; 
        } else if (view === 'addOrder' || view.includes('orders')) {
            // Updated to check for orders in general (like 'ordersList')
            baseView = 'orders';
        } else if (view === 'productList' || view === 'customerList' || view === 'reports' || view === 'dashboard') {
            baseView = view;
        }

        DOM.navButtons.forEach(btn => {
            const btnView = btn.getAttribute('data-view');
            const isActive = btnView === baseView;
            btn.classList.toggle('text-blue-600', isActive);
            btn.classList.toggle('text-gray-500', !isActive);
        });
    }

    function renderView(view, id = null) {
        loadData(); 
        DOM.content.innerHTML = ''; 

        switch (view) {
            case 'dashboard':
                DOM.title.textContent = 'Dashboard';
                renderDashboard();
                break;
            case 'productList':
                DOM.title.textContent = 'Product List';
                renderProductList();
                break;
            case 'productForm':
                DOM.title.textContent = id ? 'Edit Product' : 'Add New Product';
                renderProductForm(id);
                break;
            case 'customerList':
                DOM.title.textContent = 'Customer List';
                renderCustomerList();
                break;
            case 'customerForm':
                DOM.title.textContent = id ? 'Edit Customer' : 'Add New Customer';
                renderCustomerForm(id);
                break;
            case 'orders': // Default orders list view
                renderOrders('All');
                break;
            case 'ordersListFiltered': // Specific filtered order list view
                // This case is handled in renderOrders by the third argument which acts as the filter key
                // It should not be called directly with renderView
                console.error("ordersListFiltered should not be called directly. Use renderOrders(filterKey).");
                renderOrders('All');
                break;
            case 'addOrder':
                DOM.title.textContent = 'Add New Order';
                renderAddOrderForm();
                break;
            case 'reports':
                DOM.title.textContent = 'Reports & Export';
                renderReports();
                break;
            default:
                renderDashboard();
        }
        setActiveNav(view);
    }

    // --- Dashboard View ---

    function renderDashboard() {
        const totalSales = data.orders.filter(o => o.status === 'Delivered').reduce((sum, order) => sum + parseFloat(order.amount || 0), 0);
        const deliveredCount = data.orders.filter(o => o.status === 'Delivered').length;
        // Count for Pending and Processing
        const pendingCount = data.orders.filter(o => o.status === 'Pending' || o.status === 'Processing').length; 

        const productSales = data.orders.reduce((acc, order) => {
            const product = data.products.find(p => p.id === order.productId);
            if (product) {
                acc[product.name] = (acc[product.name] || 0) + 1;
            }
            return acc;
        }, {});

        const topProducts = Object.entries(productSales)
            .sort(([, countA], [, countB]) => countB - countA)
            .slice(0, 3);

        // Updated cardStyle to include interactivity classes
        const cardStyle = "card-bg p-4 rounded-xl soft-shadow mb-4 flex-1 cursor-pointer transform hover:scale-[1.02] active:scale-[0.98] transition-all duration-200";

        let productListHtml = '';
        if (data.products.length > 0) {
            productListHtml = `
                <div class="card-bg p-4 rounded-xl soft-shadow col-span-2 mt-4">
                    <h3 class="font-bold text-lg text-gray-700 mb-3">Recent Products Added</h3>
                    <ul class="space-y-3">
                        ${data.products.slice(0, 5).reverse().map(p => `
                            <li onclick="renderView('productForm', '${p.id}')" class="flex items-center p-3 border border-gray-100 rounded-xl card-bg soft-shadow hover:bg-gray-50 active:scale-[0.98] transition-all duration-100 cursor-pointer">
                                ${p.image ? `<img src="${p.image}" class="w-12 h-12 object-cover rounded-xl mr-3 border border-gray-200" alt="${p.name}">` : `
                                    <div class="w-12 h-12 bg-gray-200 rounded-xl mr-3 flex items-center justify-center text-gray-500 text-xs font-semibold">
                                        No Pic
                                    </div>
                                `}
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-800 truncate">${p.name} <span class="text-xs text-blue-600">(${p.size})</span></p>
                                    <p class="text-sm text-gray-600">${CURRENCY_SYMBOL}${p.price}</p>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }

        DOM.content.innerHTML = `
            <div class="grid grid-cols-2 gap-4 mb-6">
                <!-- Total Sales (Delivered Orders) - INTERACTIVE -->
                <div onclick="renderOrders('Delivered')" class="${cardStyle} bg-gradient-to-br from-blue-50 to-blue-200">
                    <p class="text-sm text-gray-600">Total Sales</p>
                    <h2 class="text-3xl font-extrabold text-blue-700 mt-1">${CURRENCY_SYMBOL}${totalSales.toFixed(2)}</h2>
                </div>
                <!-- Delivered Orders - INTERACTIVE -->
                <div onclick="renderOrders('Delivered')" class="${cardStyle} bg-gradient-to-br from-green-50 to-green-200">
                    <p class="text-sm text-gray-600">Delivered Orders</p>
                    <h2 class="text-3xl font-extrabold text-green-700 mt-1">${deliveredCount}</h2>
                </div>
                <!-- Pending & Processing Orders - INTERACTIVE -->
                <div onclick="renderOrders('Active')" class="${cardStyle} bg-gradient-to-br from-yellow-50 to-yellow-200">
                    <!-- Corrected text to match logic -->
                    <p class="text-sm text-gray-600">Pending & Processing</p>
                    <h2 class="text-3xl font-extrabold text-yellow-700 mt-1">${pendingCount}</h2>
                </div>
                <!-- Total Products - INTERACTIVE -->
                <div onclick="renderView('productList')" class="${cardStyle} bg-gradient-to-br from-pink-50 to-pink-200">
                    <p class="text-sm text-gray-600">Total Products</p>
                    <h2 class="text-3xl font-extrabold text-pink-700 mt-1">${data.products.length}</h2>
                </div>
            </div>

            <div class="card-bg p-4 rounded-xl soft-shadow col-span-2">
                <h3 class="font-bold text-lg text-gray-700 mb-3">Top Products Sold</h3>
                <ul class="space-y-2">
                    ${topProducts.length > 0 ? topProducts.map(([name, count], index) => `
                        <li class="flex justify-between items-center text-gray-600">
                            <span class="font-medium truncate">${index + 1}. ${name}</span>
                            <span class="bg-gray-100 text-sm font-semibold px-2 py-0.5 rounded-full">${count} sales</span>
                        </li>
                    `).join('') : '<li class="text-sm text-gray-500">No sales data yet.</li>'}
                </ul>
            </div>
            
            ${productListHtml}
        `;
    }

    // --- LIST VIEWS (Products & Customers) ---

    function renderProductList() {
        DOM.content.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">${data.products.length} Products Found</h2>
                <button onclick="renderView('productForm')" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-semibold soft-shadow hover:bg-blue-700 transition duration-150 flex items-center">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Add New
                </button>
            </div>
            <ul class="space-y-3 scroll-list max-h-[70vh] overflow-y-auto">
                ${data.products.length > 0 ? data.products.reverse().map(p => `
                    <li onclick="renderView('productForm', '${p.id}')" class="flex items
